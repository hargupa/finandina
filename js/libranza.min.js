var app=angular.module("Libranza",[]);app.controller("LibranzaController",["$scope","$window","$filter",function(a,o,e){firebase.initializeApp({apiKey:"AIzaSyC8vrdhMCthhxAw7CwEfN3OnVWPbHNFVpk",authDomain:"simuladores-75631.firebaseapp.com.firebaseapp.com",databaseURL:"https://simuladores-75631.firebaseio.com",storageBucket:"simuladores-75631.appspot.com.appspot.com"}),a.data={tasa:1.2,SMMLV:877803,minMontoPerimitido:3e6,minCuotaPerimitido:3e6,maxMontoPerimitido:1e8,maxCuotaPerimitido:1e8,capacidadDescuentoMonto:53400,capacidadDescuentoCuota:18e4,descuentoNomina:"",ingresos:"",selectActividad:"0",selectConvenio:"0",montoAprox:"",cuotaAprox:"",AproxCalculada:"",descuentoSalud:"",maxCuota:"",plazo:"",porcentajeDescuentos:"",errorDescNomina:"",errorIngresos:"",errorActividad:"",errorMonto:"",errorCuota:"",errorplazo:"",errorexcede:"",ShowMonto120Meses:!0,ShowMonto120MesesCuota:!1,ShowMonto108Meses:!0,ShowMonto108MesesCuota:!1,ShowMonto96Meses:!0,ShowMonto96MesesCuota:!1,ShowMonto84Meses:!0,ShowMonto84MesesCuota:!1,ShowMonto72Meses:!0,ShowMonto72MesesCuota:!1,ShowMonto60Meses:!0,ShowMonto60MesesCuota:!1,ShowTextoPorcentaje:!1,ShowImgDefault:!0,ShowImgSectorPublico:!1,ShowImgDocente:!1,ShowImgFuerzas:!1,ShowImgPensionado:!1,ShowCuota:!1,ShowMonto:!0,ShowForm:!0,ShowAviso:!1,ShowModal:!1,nombre:"",celular:"",email:""},a.Cambiar=function(){1==a.data.ShowCuota?(a.data.ShowCuota=!1,a.data.ShowMonto=!0):(a.data.ShowCuota=!0,a.data.ShowMonto=!1),a.data.montoAprox="",a.data.cuotaAprox="",a.data.AproxCalculada="",a.data.errorDescNomina="",a.data.errorIngresos="",a.data.errorActividad="",a.data.errorMonto="",a.data.errorCuota="",a.data.errorplazo="",a.data.errorexcede=""},a.limpiarPlazo=function(){a.data.plazo="",a.data.ShowMonto120Meses=!0,a.data.ShowMonto120MesesCuota=!1,a.data.ShowMonto108Meses=!0,a.data.ShowMonto108MesesCuota=!1,a.data.ShowMonto96Meses=!0,a.data.ShowMonto96MesesCuota=!1,a.data.ShowMonto84Meses=!0,a.data.ShowMonto84MesesCuota=!1,a.data.ShowMonto72Meses=!0,a.data.ShowMonto72MesesCuota=!1,a.data.ShowMonto60Meses=!0,a.data.ShowMonto60MesesCuota=!1},a.CambiarActividad=function(){switch(a.data.ShowImgDefault=!1,a.data.ShowImgSectorPublico=!1,a.data.ShowImgDocente=!1,a.data.ShowImgFuerzas=!1,a.data.ShowImgPensionado=!1,a.limpiarPlazo(),a.data.selectActividad){case"0":a.data.ShowImgDefault=!0;break;case"1":a.data.ShowImgSectorPublico=!0;break;case"2":a.data.ShowImgDocente=!0;break;case"3":a.data.ShowImgFuerzas=!0;break;case"4":a.data.ShowImgPensionado=!0}a.calcularDatos()},a.MostrarCuota=function(o){switch(a.limpiarPlazo(),o){case 0:a.data.plazo=120,a.data.ShowMonto120Meses=!1,a.data.ShowMonto120MesesCuota=!0;break;case 1:a.data.plazo=108,a.data.ShowMonto108Meses=!1,a.data.ShowMonto108MesesCuota=!0;break;case 2:a.data.plazo=96,a.data.ShowMonto96Meses=!1,a.data.ShowMonto96MesesCuota=!0;break;case 3:a.data.plazo=84,a.data.ShowMonto84Meses=!1,a.data.ShowMonto84MesesCuota=!0;break;case 4:a.data.plazo=72,a.data.ShowMonto72Meses=!1,a.data.ShowMonto72MesesCuota=!0;break;case 5:a.data.plazo=60,a.data.ShowMonto60Meses=!1,a.data.ShowMonto60MesesCuota=!0}a.calcularDatos()},a.mostrarTerminos=function(){a.data.ShowForm=!1,a.data.ShowTerminos=!0},a.ocultarTerminos=function(){a.data.ShowForm=!0,a.data.ShowTerminos=!1},a.validaciones=function(){if(a.data.errorActividad="",a.data.errorIngresos="",a.data.errorDescNomina="",a.data.errorMonto="",a.data.errorCuota="",a.data.errorplazo="",a.data.errorexcede="",a.data.AproxCalculada="","0"==a.data.selectActividad)return a.data.errorActividad="Debe indicar su actividad",!1;if(""==a.data.ingresos)return a.data.errorIngresos="Debe indicar sus ingresos",!1;if(!a.data.ShowImgPensionado&&(_ingresos=a.data.ingresos.replace(/\,/g,""),_ingresos<a.data.SMMLV))return a.data.errorIngresos="Ingreso mínimo 1 SMMLV",!1;if(""==a.data.descuentoNomina)return a.data.ShowImgPensionado?a.data.errorDescNomina="Debe indicar sus descuentos":a.data.errorDescNomina="Debe indicar sus descuentos por nómina",!1;if(a.data.ShowMonto){if(""==a.data.montoAprox)return a.data.errorMonto="Debe indicar la cantidad de dinero que necesita",!1;if(_montoAprox=a.data.montoAprox.replace(/\,/g,""),_montoAprox<a.data.minMontoPerimitido)return a.data.errorMonto="El monto del dinero no puede ser inferior a "+e("currency")(a.data.minMontoPerimitido,"$",0),!1;if(_montoAprox>a.data.maxMontoPerimitido)return a.data.errorMonto="El monto que intentas solicitar es superior a tu capacidad de endeudamiento, el valor máximo que te podemos prestar es "+e("currency")(a.data.maxMontoPerimitido,"$",0),!1}return a.data.ShowCuota&&""==a.data.cuotaAprox?(a.data.errorCuota="Debe indicar la cuota que quiere pagar",!1):""!=a.data.plazo||(a.data.errorplazo="Debe indicar el plazo en el que quiere pagar",!1)},a.calcularDatos=function(){if(!a.validaciones())return!1;if(""==a.data.porcentajeDescuentos&&(a.data.ShowImgPensionado?a.data.porcentajeDescuentos=.12:a.data.porcentajeDescuentos=.08),_ingresos=a.data.ingresos.replace(/\,/g,""),_descuentoNomina=a.data.descuentoNomina.replace(/\,/g,""),a.data.descuentoSalud=_ingresos*a.data.porcentajeDescuentos,a.data.maxCuota=(_ingresos-a.data.descuentoSalud)/2-_descuentoNomina,a.data.ShowMonto){if(a.data.maxCuota<a.data.capacidadDescuentoMonto)return void(a.data.errorexcede="La cuota mensual excede tu capacidad de descuento");_montoAprox=a.data.montoAprox.replace(/\,/g,"");var o=a.calculoCuotaAprox(a.data.tasa,a.data.plazo,_montoAprox);if(o>a.data.maxCuota)return void(a.data.errorexcede="La cuota mensual excede tu capacidad de descuento");a.data.AproxCalculada=o}else if(a.data.ShowCuota){if(a.data.maxCuota<a.data.capacidadDescuentoCuota)return void(a.data.errorexcede="La cuota indicada excede tu capacidad de descuento");if(_cuotaAprox=a.data.cuotaAprox.replace(/\,/g,""),_cuotaAprox>a.data.maxCuota)return void(a.data.errorexcede="La cuota indicada excede tu capacidad de descuento");var e=a.calculoMontoAprox(a.data.tasa,a.data.plazo,_cuotaAprox);a.data.AproxCalculada=a.calculoRedondearMenos(e,5)}},a.calculoCuotaAprox=function(a,o,e){var t=a/100,r=Math.pow(1+t,o),n=t*r*e/(r-1);return isNaN(n)&&(n=0),Math.round(n)},a.calculoMontoAprox=function(a,o,e){var t=a/100,r=Math.pow(1+t,o),n=e*((r-1)/(t*r));n=Math.round(n);var d=Math.min(n,1e8);return isNaN(d)&&(result=0),d},a.calculoRedondearMenos=function(a,o){var e=a.toString(),t=e.length;if(t>o){for(var r=t-o,n=e.slice(0,r),d=0;d<o;d++)n=n.concat("0");return parseInt(n)}return 0},a.obtenerDatos=function(){a.data.selectActividad=localStorage.getItem("selectActividad"),a.CambiarActividad()},a.guardarInfo=function(){if(a.data.errornombre="",a.data.errorcel="",a.data.erroremail="",""==a.data.nombre)return a.data.errornombre="Debe ingresar su nombre y apellido",!1;if(isNaN(a.data.celular)||!/^3[\d]{9}$/.test(a.data.celular))return a.data.errorcel="Debe ingresar un número con el formato correcto",!1;if(""==a.data.email)return a.data.erroremail="Debe ingresar su correo electrónico",!1;if(!/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(a.data.email))return a.data.erroremail="Debe ingresar una dirección de correo electrónico con el formato correcto",!1;a.writeFirebase()&&(a.data.ShowModal=!0)},a.writeFirebase=function(){var o=localStorage.getItem("simulacion"),e=JSON.parse(o),t=!1;try{var r={DatosPersonales:{nombre:a.data.nombre,celular:a.data.celular,email:a.data.email},Simulacion:e};t=firebase.database().ref("libranza").push(r)}catch(a){console.log(a)}return localStorage.removeItem("simulacion"),t},a.contactenos=function(){if(localStorage.setItem("selectActividad",a.data.selectActividad),""!=a.data.ingresos&&""!=a.data.descuentoNomina){montoAprox=a.data.montoAprox.replace(/\,/g,""),cuotaAprox=a.data.cuotaAprox.replace(/\,/g,""),ingresos=a.data.ingresos.replace(/\,/g,""),descuentoNomina=a.data.descuentoNomina.replace(/\,/g,"");var e={esMonto:a.data.ShowMonto,esCuota:a.data.ShowCuota,Actividad:a.data.selectActividad,convenio:a.data.selectConvenio,ingresos:ingresos,descuentoNomina:descuentoNomina,porcentajeDescuentoSalud:a.data.porcentajeDescuentos,descuentoSalud:a.data.descuentoSalud,montoFinanciar:""!=montoAprox?montoAprox:0,cuotaFinanciar:""!=cuotaAprox?cuotaAprox:0,plazo:a.data.plazo,tasa:a.data.cuotaMensual};localStorage.setItem("simulacion",JSON.stringify(e))}o.location.href="formContacto.html"},a.showindex=function(){o.location.href="index.html"}}]),app.directive("mileskeypress",(function(){return{restrict:"A",require:"ngModel",link:function(a,o,e,t){var r=function(a){if(void 0===a)return"";var o=(a=a.replace(/\,/g,"")).replace(/[^0-9,]/g,"");if(o!==a)t.$setViewValue(o),t.$render();else{if(o>999){for(var e=parseInt(o).toString().split(""),r=0,n=[],d=e.length-1,i=d;i>=0;i--){var s=e[i].replace(/\,/g,"");""!=s&&(d>=3?2==r&&0!=i?(n[i]=","+s,r=0):(n[i]=s,r+=1):n[i]=s)}o=n.join("")}t.$setViewValue(o),t.$render(),t.$setValidity("onlyNumbers",!0)}return o};t.$parsers.unshift(r),t.$parsers.push(r),e.$observe("onlyNumbers",(function(){r(t.$ViewValue)}))}}})).directive("letterkeypress",(function(){return{restrict:"A",require:"ngModel",link:function(a,o,e,t){var r=function(a){if(void 0===a)return"";var o=a.replace(/[^A-Za-z ]/g,"");return o!==a?(t.$setViewValue(o),t.$render()):t.$setValidity("onlyLetters",!0),o};t.$parsers.unshift(r),t.$parsers.push(r),e.$observe("onlyLetters",(function(){r(t.$ViewValue)}))}}})).directive("numberkeypress",(function(){return{restrict:"A",require:"ngModel",link:function(a,o,e,t){var r=function(a){if(void 0===a)return"";var o=a.replace(/[^0-9]/g,"");return o!==a?(t.$setViewValue(o),t.$render()):t.$setValidity("onlyNumbers",!0),o};t.$parsers.unshift(r),t.$parsers.push(r),e.$observe("onlyLetters",(function(){r(t.$ViewValue)}))}}}));