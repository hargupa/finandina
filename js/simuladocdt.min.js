var app=angular.module("simuladorCDT",[]);app.controller("CdtController",["$scope","$window","$filter",function(a,e,t){firebase.initializeApp({apiKey:"AIzaSyC8vrdhMCthhxAw7CwEfN3OnVWPbHNFVpk",authDomain:"simuladores-75631.firebaseapp.com.firebaseapp.com",databaseURL:"https://simuladores-75631.firebaseio.com",storageBucket:"simuladores-75631.appspot.com.appspot.com"}),a.Math=window.Math,a.data={montoInversion:"",tasaEA:"",tasaEA_texto:"",plazoDias:"",fuente:4,ica:0,modalidad:"V",montoInteresNeto:"",totalInversion:"",errormonto:"",errordias:"",mindias:90,maxdias:540,minMontoInversion:1e6,lstTasas:[{plazo:"90",plazoHasta:"179",tasa:"2.25",monto:1e6,montoHasta:1e8},{plazo:"180",plazoHasta:"359",tasa:"2.40",monto:1e6,montoHasta:1e8},{plazo:"360",plazoHasta:"539",tasa:"2.50",monto:1e6,montoHasta:1e8},{plazo:"540",plazoHasta:"540",tasa:"2.70",monto:1e6,montoHasta:1e8},{plazo:"90",plazoHasta:"179",tasa:"2.35",monto:1e8,montoHasta:5e8},{plazo:"180",plazoHasta:"359",tasa:"2.50",monto:1e8,montoHasta:5e8},{plazo:"360",plazoHasta:"539",tasa:"2.60",monto:1e8,montoHasta:5e8},{plazo:"540",plazoHasta:"540",tasa:"2.80",monto:1e8,montoHasta:5e8}],ShowModal:!1,nombre:"",celular:"",email:""},a.CalcularTasaEA=function(e,t){var o=a.data.lstTasas.find(a=>e>=a.plazo&&e<=a.plazoHasta&&t>=a.monto&&t<=a.montoHasta);if(null!=o)a.data.tasaEA=o.tasa,a.data.tasaEA_texto=o.tasa+"% EA";else{var r=0,n=a.data.lstTasas.filter(a=>e>=a.plazo&&e<=a.plazoHasta);if(n.length>0){r=n[0].tasa;for(var s=1;s<n.length;s++){var i=n[s].tasa;i>r&&(r=i)}}a.data.tasaEA=r,a.data.tasaEA_texto=r+"% EA"}},a.calculos=function(){if(a.data.tasaEA="",a.data.tasaEA_texto="",a.data.errormonto="",a.data.errordias="",a.data.montoInteresNeto="",a.data.totalInversion="",""==a.data.montoInversion)return a.data.errormonto="Debe ingresar el monto de la inversión",!1;if(""==a.data.plazoDias||null==a.data.plazoDias)return a.data.errordias="Debe ingresar el plazo en días",!1;if(_montoInversion=a.data.montoInversion.replace(/\,/g,""),_montoInversion<a.data.minMontoInversion)return a.data.errormonto="El monto mínimo para la inversión es de "+t("currency")(a.data.minMontoInversion,"$",0),!1;if(a.data.plazoDias<a.data.mindias)return a.data.errordias="El mínimo de días es "+a.data.mindias+" días.",!1;if(a.data.plazoDias>a.data.maxdias)return a.data.errordias="El máximo de días es "+a.data.maxdias+" días.",!1;if(a.CalcularTasaEA(a.data.plazoDias,_montoInversion),""==a.data.tasaEA)return a.data.errordias="La tasa esta vacia",!1;var e=0;e=a.cdtNormal(_montoInversion),a.data.montoInteresNeto=e.toFixed(2),a.data.totalInversion=parseInt(_montoInversion)+parseInt(a.data.montoInteresNeto),a.data.fechaFinal=a.sumarDias(new Date,a.data.plazoDias)},a.sumarDias=function(a,e){e+=a.getDate();for(var t,o=a.getMonth()+1,r=a.getFullYear(),n=!1,s=!1,i=2020;i<=t;i++)(i%4==0&&i%100!=0||i%400==0)&&(s=!0);for(;0==n;){for(t=r;i<=t;i++)(i%4==0&&i%100!=0||i%400==0)&&(s=!0);switch(o){case 1:e<=31?n=!0:(e-=31,o+=1);break;case 2:var l;e<=(l=1==s?29:28)?n=!0:(e-=l,o+=1);break;case 3:e<=31?n=!0:(e-=31,o+=1);break;case 4:e<=30?n=!0:(e-=30,o+=1);break;case 5:e<=31?n=!0:(e-=31,o+=1);break;case 6:e<=30?n=!0:(e-=30,o+=1);break;case 7:case 8:e<=31?n=!0:(e-=31,o+=1);break;case 9:e<=30?n=!0:(e-=30,o+=1);break;case 10:e<=31?n=!0:(e-=31,o+=1);break;case 11:e<=30?n=!0:(e-=30,o+=1);break;case 12:e<=31?n=!0:(e-=31,o=1,r+=1)}}return e+"/"+o+"/"+r},a.TasaCalculaNominal=function(a,e){var t=360/e,o=t*(Math.pow(1+a,1/t)-1);return isNaN(o)&&(o=0),o},a.redondeaSeisDecimas=function(a){return Math.round(1e6*a)/1e6},a.cdtNormal=function(e){var t=a.data.tasaEA/100,o=a.TasaCalculaNominal(t,a.data.plazoDias),r=e*a.redondeaSeisDecimas(o)/(360/a.data.plazoDias);return r-(r*(a.data.fuente/100)+r*(a.data.ica/100))},a.cdtDesmaterializado=function(){a.data.tasaEA;var e=Math.round(a.data.tasaEA/360*a.data.plazoDias).toFixed(6),t=Math.round(e*a.data.montoInversion),o=t-(Math.round(t*(a.data.fuente/100))+Math.round(t*(a.data.ica/100)));return a.data.montoInteresNeto=o,o},a.guardarInfo=function(){if(a.data.errornombre="",a.data.errorcel="",a.data.erroremail="",""==a.data.nombre)return a.data.errornombre="Debe ingresar su nombre y apellido",!1;if(isNaN(a.data.celular)||!/^3[\d]{9}$/.test(a.data.celular))return a.data.errorcel="Debe ingresar un número con el formato correcto",!1;if(""==a.data.email)return a.data.erroremail="Debe ingresar su correo electrónico",!1;if(!/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(a.data.email))return a.data.erroremail="Debe ingresar una dirección de correo electrónico con el formato correcto",!1;a.writeFirebase()&&(a.data.ShowModal=!0)},a.writeFirebase=function(){var e=localStorage.getItem("simulacion"),t=JSON.parse(e),o=!1;try{var r={DatosPersonales:{nombre:a.data.nombre,celular:a.data.celular,email:a.data.email},Simulacion:t};o=firebase.database().ref("cdt").push(r)}catch(a){console.log(a)}return localStorage.removeItem("simulacion"),o},a.contactenos=function(){if(""!=a.data.montoInversion&&""!=a.data.plazoDias){_montoInversion=a.data.montoInversion.replace(/\,/g,"");var t={montoInversion:_montoInversion,tasaEA:a.data.tasaEA,periodo:"dias",plazoDias:a.data.plazoDias,retencionFuente:a.data.fuente,retencionIca:a.data.ica,montoInteresNeto:a.data.montoInteresNeto,totalInversion:a.data.totalInversion,fechaFinal:a.fechaFinal};localStorage.setItem("simulacion",JSON.stringify(t))}e.location.href="formContacto.html"},a.showindex=function(){e.location.href="index.html"}}]),app.directive("mileskeypress",(function(){return{restrict:"A",require:"ngModel",link:function(a,e,t,o){var r=function(a){if(void 0===a)return"";var e=(a=a.replace(/\,/g,"")).replace(/[^0-9,]/g,"");if(e!==a)o.$setViewValue(e),o.$render();else{if(e>999){for(var t=parseInt(e).toString().split(""),r=0,n=[],s=t.length-1,i=s;i>=0;i--){var l=t[i].replace(/\,/g,"");""!=l&&(s>=3?2==r&&0!=i?(n[i]=","+l,r=0):(n[i]=l,r+=1):n[i]=l)}e=n.join("")}o.$setViewValue(e),o.$render(),o.$setValidity("onlyNumbers",!0)}return e};o.$parsers.unshift(r),o.$parsers.push(r),t.$observe("onlyNumbers",(function(){r(o.$ViewValue)}))}}})).directive("letterkeypress",(function(){return{restrict:"A",require:"ngModel",link:function(a,e,t,o){var r=function(a){if(void 0===a)return"";var e=a.replace(/[^A-Za-z ]/g,"");return e!==a?(o.$setViewValue(e),o.$render()):o.$setValidity("onlyLetters",!0),e};o.$parsers.unshift(r),o.$parsers.push(r),t.$observe("onlyLetters",(function(){r(o.$ViewValue)}))}}})).directive("numberkeypress",(function(){return{restrict:"A",require:"ngModel",link:function(a,e,t,o){var r=function(a){if(void 0===a)return"";var e=a.replace(/[^0-9]/g,"");return e!==a?(o.$setViewValue(e),o.$render()):o.$setValidity("onlyNumbers",!0),e};o.$parsers.unshift(r),o.$parsers.push(r),t.$observe("onlyLetters",(function(){r(o.$ViewValue)}))}}}));